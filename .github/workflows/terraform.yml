# GitHub Actions workflow for Terraform vulnerability scanning with Checkov
name: Terraform Security Scan

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.tf'
      - '**.tfvars'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**.tf'
      - '**.tfvars'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  checkov-scan:
    name: Checkov Terraform Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Option 1: Run Checkov directly with Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Checkov
        run: pip install checkov
      
      - name: Run Checkov scan
        run: checkov --directory . --framework terraform --output cli --output sarif --output-file-path results.sarif
      
      # Upload results as artifacts for reviewing later
      - name: Upload SARIF results
        uses: actions/upload-artifact@v3
        with:
          name: checkov-results
          path: results.sarif
      
      # Option 2 (Alternative): Using Bridgecrew's Checkov GitHub Action
      # - name: Run Checkov scan with GitHub Action
      #   uses: bridgecrewio/checkov-action@master
      #   with:
      #     directory: .
      #     framework: terraform
      #     skip_check: CKV_AWS_1,CKV_AWS_2  # Optional: skip specific checks
      #     quiet: true  # Optional: display only failed checks
      #     soft_fail: true  # Optional: don't fail the build for errors
      
      # Optional: Publish results to GitHub Security tab
      - name: Upload SARIF file to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()  # Run this step even if previous steps fail
        with:
          sarif_file: results.sarif
